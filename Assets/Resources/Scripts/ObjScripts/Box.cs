using Assets.PixelHeroes.Scripts.ExampleScripts;
using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.UI;
using KoreanTyper;
using Photon.Pun.Demo.PunBasics;

public class Box : MonoBehaviour
{
    [Header("채팅 아이콘")]
    public GameObject boxChat;
    [Header("열린 박스 이미지")]
    public Sprite openBoxImage;
    [Header("닫힌 박스 이미지")]
    public Sprite closeBoxImage;

    [Header("박스 대사")]
    [TextArea]
    public string boxDesc;

    [Header("플레이어 스크립트")]
    public CharacterControls characterControls;
    [Header("플레이어의 해금할 능력")]
    public CharacterControls.PlayerStateType boxAbility;



    SpriteRenderer spriteRenderer;
    BattleUIManager battleUIManager;
    public GameManager gameManager;

    [Header("펼칠 종이(종이 사용 여부)")]
    public GameObject customPaper;
    Rigidbody2D rigid;

    public enum BoxType { Train, Paper }
    public BoxType boxType;


    private void Awake()
    {
        spriteRenderer = GetComponent<SpriteRenderer>();
        rigid = GetComponent<Rigidbody2D>();
        battleUIManager = BattleUIManager.Instance;

        if (boxType == BoxType.Paper)
            rigid.bodyType = RigidbodyType2D.Static;
    }

    private void OnCollisionEnter2D(Collision2D other)
    {
        if (other.transform.CompareTag("Player"))
        {
            if (boxType == BoxType.Train)
            {
                battleUIManager.typingControl(boxDesc);

                if (boxChat.activeSelf)
                {
                    //열린 형태로 변화
                    changeForm(true);
                    //점수 증가
                    battleUIManager.curScore += 10;
                    //플레이어 능력 해금
                    characterControls.changeStateRPC(boxAbility, true);


                    //등짝의 칼 활성화
                    if (boxAbility == CharacterControls.PlayerStateType.RightControl)
                    {
                        characterControls.backSwords.SetActive(true);
                    }
                    //효과음 출력
                    battleUIManager.audioManager.PlaySfx(AudioManager.Sfx.PowerUp);
                    //이펙트 생성
                    GameObject effect = gameManager.CreateObj("congratulation 9", GameManager.PoolTypes.EffectType);//"Explosion 2"
                    effect.SetActive(true);
                    effect.transform.position = transform.position;
                }
            }
            else if (boxType == BoxType.Paper)//종이 사용 
            {
                ControlAdavancedBox(true);
            }
        }
    }

    public void ControlAdavancedBox(bool isOpen) 
    {
        //효과음 출력
        battleUIManager.audioManager.PlaySfx(AudioManager.Sfx.Paper);
        characterControls.xyRPC(0, 0);

        ///열린 형태로 변화
        changeForm(isOpen);
        //대상 열기
        customPaper.SetActive(isOpen);

        characterControls.changeStateRPC(CharacterControls.PlayerStateType.LeftControl, !isOpen);
        characterControls.changeStateRPC(CharacterControls.PlayerStateType.RightControl, !isOpen);

        battleUIManager.JoySizeControl(!isOpen);
    }

    //헤드: Hair2#FFFFFF/0:0:0
    //눈: Human#FFFFFF/0:0:0
    //몸: Human#FFFFFF/0:0:0
    //머리카락: Hair2#FFFFFF/0:0:0
    //아머: PirateCostume#FFFFFF/0:0:0


    public void changeForm(bool isOpen)
    {
        //채팅 이미지 비활성화
        boxChat.SetActive(!isOpen);
        if (isOpen) //연 것
        {
            //박스 이미지 변화
            spriteRenderer.sprite = openBoxImage;
        }
        else if (!isOpen)//닫은 것
        {
            //박스 이미지 변화
            spriteRenderer.sprite = closeBoxImage;
        }

    }

    private void OnTriggerEnter2D(Collider2D other)
    {
        if (other.transform.CompareTag("Outline")) //맵 밖으로 나가지면 종료
        {
            Destroy(this.gameObject);
        }
    }

    
}
